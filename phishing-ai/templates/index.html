<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Email Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Phishing Email Analyzer</h1>
        <p class="subtitle">AI-powered email threat detection</p>

        {% if error_msg %}
            <div class="alert error">{{ error_msg }}</div>
        {% endif %}

        <form method="POST" action="/" class="email-form">
            <div class="form-group">
                <label for="email_text">Paste raw email content (headers + body):</label>
                <textarea id="email_text" name="email_text" rows="15"
                    placeholder="From: sender@example.com
To: recipient@example.com
Subject: Your account needs verification

Dear User,
Please click the link below to verify your account..."></textarea>
            </div>

            <div class="form-group-btn">
                <button type="submit">Analyze Email</button>
            </div>
        </form>

        {% if result %}
        <div class="results">
            <div class="verdict-section">
                <h2>Verdict</h2>
                <div class="verdict-box {% if result.verdict == 'PHISHING' %}phishing{% elif result.verdict == 'SUSPICIOUS' %}suspicious{% else %}safe{% endif %}">
                    <span class="verdict-label">{{ result.verdict }}</span>
                    <span class="confidence">{{ result.confidence }}% confidence</span>
                </div>
            </div>

            <div class="scores-grid">
                <div class="score-card">
                    <div class="score-title">AI Model Score</div>
                    <div class="score-value {% if result.ai_score and result.ai_score >= 70 %}high{% elif result.ai_score and result.ai_score >= 40 %}medium{% else %}low{% endif %}">
                        {{ result.ai_score|default('-', true) }}{% if result.ai_score %}%{% endif %}
                    </div>
                </div>
                <div class="score-card">
                    <div class="score-title">Sublime Score</div>
                    <div class="score-value {% if result.sublime_score and result.sublime_score >= 70 %}high{% elif result.sublime_score and result.sublime_score >= 40 %}medium{% else %}low{% endif %}">
                        {{ result.sublime_score|default('-', true) }}{% if result.sublime_score %}%{% endif %}
                    </div>
                </div>
            </div>

            {% if indicators %}
            <div class="section">
                <h3>Detected Indicators</h3>
                <ul class="indicator-list">
                    {% for indicator in indicators %}
                    <li class="indicator-item">{{ indicator }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if reasons %}
            <div class="section">
                <h3>AI Reasoning</h3>
                <ul class="reasons-list">
                    {% for reason in reasons %}
                    <li class="reason-item">{{ reason }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if check_results %}
            <div class="section">
                <h3>Detection Checks</h3>
                <div class="checks-grid">
                    {% set check_display = {
                        'bert_model': {'label': 'BERT AI Model', 'icon': 'ü§ñ', 'weight': '30%'},
                        'sublime': {'label': 'Sublime Security', 'icon': 'üõ°Ô∏è', 'weight': '20%'},
                        'html_threats': {'label': 'HTML Threats', 'icon': 'üìÑ', 'weight': '8%'},
                        'header_mismatch': {'label': 'Header Mismatch', 'icon': 'üìß', 'weight': '7%'},
                        'urgency_keywords': {'label': 'Urgency Keywords', 'icon': '‚ö°', 'weight': '7%'},
                        'shortened_urls': {'label': 'URL Shorteners', 'icon': 'üîó', 'weight': '5%'},
                        'urlscan': {'label': 'URLScan.io', 'icon': 'üîç', 'weight': '5%'},
                        'suspicious_tlds': {'label': 'Suspicious TLDs', 'icon': 'üåê', 'weight': '4%'},
                        'dns_records': {'label': 'DNS Records', 'icon': 'üì°', 'weight': '4%'},
                        'virustotal': {'label': 'VirusTotal', 'icon': 'ü¶†', 'weight': '4%'},
                        'spf_record': {'label': 'SPF Record', 'icon': '‚úâÔ∏è', 'weight': '3%'},
                        'domain_age': {'label': 'Domain Age', 'icon': 'üìÖ', 'weight': '3%'}
                    } %}
                    {% for key, check in check_results.items() %}
                    <div class="check-card {% if check.error %}error{% elif check.passed %}passed{% else %}failed{% endif %}">
                        <div class="check-header">
                            <span class="check-icon">{{ check_display.get(key, {}).get('icon', 'üîé') }}</span>
                            <span class="check-name">{{ check_display.get(key, {}).get('label', check.name) }}</span>
                            <span class="check-weight">{{ check_display.get(key, {}).get('weight', '') }}</span>
                        </div>
                        <div class="check-score">
                            {% if check.error %}
                                <span class="score-error">Error</span>
                            {% elif check.score is not none %}
                                <span class="score-number {% if check.score >= 70 %}high{% elif check.score >= 40 %}medium{% else %}low{% endif %}">{{ check.score|round|int }}%</span>
                            {% else %}
                                <span class="score-na">N/A</span>
                            {% endif %}
                        </div>
                        <div class="check-status">
                            {% if check.error %}
                                <span class="status-badge error">{{ check.error|truncate(30, True, '...') }}</span>
                            {% elif check.passed %}
                                <span class="status-badge passed">Passed</span>
                            {% else %}
                                <span class="status-badge failed">Flagged</span>
                            {% endif %}
                        </div>
                        {% if check.details %}
                        <div class="check-details">
                            {% if key == 'bert_model' and check.details.label %}
                                <span class="detail-item">Label: {{ check.details.label }}</span>
                            {% endif %}
                            {% if key == 'sublime' and check.details.verdict %}
                                <span class="detail-item">Verdict: {{ check.details.verdict }}</span>
                                {% if check.details.top_signals %}
                                    <span class="detail-item">Signals: {{ check.details.top_signals|join(', ') }}</span>
                                {% endif %}
                            {% endif %}
                            {% if key == 'header_mismatch' and check.details.mismatch %}
                                <span class="detail-item">From: {{ check.details.from }}</span>
                                <span class="detail-item">Reply-To: {{ check.details.reply_to }}</span>
                            {% endif %}
                            {% if key == 'urgency_keywords' and check.details.found_phrases %}
                                <span class="detail-item">Found: {{ check.details.found_phrases|join(', ') }}</span>
                            {% endif %}
                            {% if key == 'html_threats' and check.details.threats_found %}
                                <span class="detail-item">Threats: {{ check.details.threats_found[:3]|join(', ') }}{% if check.details.threats_found|length > 3 %}...{% endif %}</span>
                            {% endif %}
                            {% if key == 'shortened_urls' and check.details.shortened_domains %}
                                <span class="detail-item">Shorteners: {{ check.details.shortened_domains|join(', ') }}</span>
                            {% endif %}
                            {% if key == 'suspicious_tlds' and check.details.suspicious_domains %}
                                <span class="detail-item">Domains: {{ check.details.suspicious_domains|join(', ') }}</span>
                            {% endif %}
                            {% if key == 'dns_records' %}
                                <span class="detail-item">Domain: {{ check.details.domain }}</span>
                                <span class="detail-item">MX: {{ 'Yes' if check.details.has_mx else 'No' }} | A: {{ 'Yes' if check.details.has_a else 'No' }}</span>
                            {% endif %}
                            {% if key == 'spf_record' %}
                                <span class="detail-item">SPF: {{ 'Found' if check.details.has_spf else 'Missing' }}</span>
                            {% endif %}
                            {% if key == 'domain_age' and check.details.new_domains %}
                                <span class="detail-item">New: {{ check.details.new_domains|join(', ') }}</span>
                            {% endif %}
                            {% if key == 'urlscan' and check.details.url %}
                                <span class="detail-item">URL: {{ check.details.url[:40] }}{% if check.details.url|length > 40 %}...{% endif %}</span>
                            {% endif %}
                            {% if key == 'virustotal' and check.details.attachments_scanned %}
                                <span class="detail-item">Scanned: {{ check.details.attachments_scanned }} attachment(s)</span>
                                {% if check.details.total_malicious %}
                                    <span class="detail-item">Malicious: {{ check.details.total_malicious }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <footer>
            <p>Phishing Detection API v1.0</p>
        </footer>
    </div>
</body>
</html>
